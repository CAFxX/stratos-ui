---
platform: linux
inputs:
- name: stratos-ui
- name: helm-chart-Chart
- name: helm-chart-values
outputs:
- name: helm-chart
image_resource:
  type: docker-image
  source:
   repository:  ci-registry.ngrok.io:80/linkyard/helm
   tag: "latest"
   insecure_registries: [ "ci-registry.ngrok.io:80" ]

run:
  path: sh
  args:
    - -exc
    - |
      mkdir ~/.kube
      cat << EOF >> ~/.kube/config
      apiVersion: v1
      kind: Config
      clusters:
      - name: local
        cluster:
          server: ${CAASP_SERVER}
          certificate-authority-data: ${CAASP_CLUSTER_AUTHORITY_DATA}
      users:
      - name: kubelet
        user:
          client-certificate-data: ${CAASP_CLIENT_CERTIFICATE_DATA}
          client-key-data: ${CAASP_CLIENT_CLIENT_KEY_DATA}
      contexts:
      - context:
          cluster: local
          user: kubelet
      EOF

      kubectl cluster-info
      helm init || true
      
      ROOT_DIR=$PWD
      STRATOS_UI=${ROOT_DIR}/stratos-ui
      cd ${STRATOS_UI}/deploy/kubernetes/

      cp -f ${ROOT_DIR}/helm-chart-values/values.yaml-helm-nightly console/values.yaml
      cp -f ${ROOT_DIR}/helm-chart-Chart/Chart.yaml-helm-nightly console/Chart.yaml

      helm install console --namespace nightly-test --name console
      sleep 120

      helm list
      kubectl get po --all-namespaces

      helm delete console --purge